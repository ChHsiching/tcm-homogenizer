<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Electronç¯å¢ƒæ¨¡æ‹Ÿæµ‹è¯•</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .section { margin: 20px 0; padding: 20px; border: 1px solid #ccc; }
        .btn { padding: 10px 20px; margin: 5px; cursor: pointer; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .nav-btn { padding: 10px 20px; margin: 5px; cursor: pointer; }
        .nav-btn.active { background-color: #007bff; color: white; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Electronç¯å¢ƒæ¨¡æ‹Ÿæµ‹è¯•</h1>
        
        <!-- ç™»å½•ç•Œé¢ -->
        <div id="login-container" class="section">
            <h2>ç™»å½•</h2>
            <input type="text" id="username" placeholder="ç”¨æˆ·å" value="admin">
            <input type="password" id="password" placeholder="å¯†ç " value="admin123">
            <button class="btn" onclick="login()">ç™»å½•</button>
            <div id="login-status"></div>
        </div>
        
        <!-- ä¸»ç•Œé¢ -->
        <div id="main-container" class="section" style="display: none;">
            <h2>ä¸»ç•Œé¢</h2>
            
            <!-- å¯¼èˆªèœå• -->
            <div class="nav-menu">
                <button class="nav-btn active" data-tab="home">é¦–é¡µ</button>
                <button class="nav-btn" data-tab="user-management">ç”¨æˆ·ç®¡ç†</button>
            </div>
            
            <!-- æ ‡ç­¾é¡µå†…å®¹ -->
            <div id="home" class="tab-content active">
                <h3>é¦–é¡µ</h3>
                <p>æ¬¢è¿ä½¿ç”¨ç³»ç»Ÿ</p>
            </div>
            
            <div id="user-management" class="tab-content">
                <h3>ç”¨æˆ·ç®¡ç†</h3>
                <div class="user-section">
                    <div class="user-actions">
                        <button id="add-user-btn" class="btn">æ·»åŠ ç”¨æˆ·</button>
                        <button id="refresh-users-btn" class="btn">åˆ·æ–°åˆ—è¡¨</button>
                    </div>
                    <div class="user-list">
                        <h4>ç”¨æˆ·åˆ—è¡¨</h4>
                        <div id="users-table" class="data-table">
                            <p>åŠ è½½ä¸­...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // æ¨¡æ‹ŸElectron API
        window.electronAPI = {
            onMenuImportData: (callback) => console.log('èœå•äº‹ä»¶ç›‘å¬å™¨å·²è®¾ç½®'),
            onMenuExportResults: (callback) => console.log('èœå•äº‹ä»¶ç›‘å¬å™¨å·²è®¾ç½®'),
            onMenuSymbolicRegression: (callback) => console.log('èœå•äº‹ä»¶ç›‘å¬å™¨å·²è®¾ç½®'),
            onMenuMonteCarlo: (callback) => console.log('èœå•äº‹ä»¶ç›‘å¬å™¨å·²è®¾ç½®'),
            onMenuAbout: (callback) => console.log('èœå•äº‹ä»¶ç›‘å¬å™¨å·²è®¾ç½®')
        };

        // å…¨å±€å‡½æ•°
        function showNotification(message, type = 'info') {
            console.log(`é€šçŸ¥ [${type}]: ${message}`);
        }

        function showLoading(text = 'æ­£åœ¨å¤„ç†...') {
            console.log(`åŠ è½½: ${text}`);
        }

        function hideLoading() {
            console.log('éšè—åŠ è½½çŠ¶æ€');
        }

        // è®¤è¯ç®¡ç†å™¨
        class AuthManager {
            constructor() {
                this.currentUser = null;
                this.isAuthenticated = false;
                this.apiBaseUrl = 'http://127.0.0.1:5000/api/auth';
            }

            async initialize() {
                console.log('ğŸ” åˆå§‹åŒ–è®¤è¯ç³»ç»Ÿ...');
                this.setupAuthEventListeners();
                console.log('âœ… è®¤è¯ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');
            }

            setupAuthEventListeners() {
                // ç”¨æˆ·ç®¡ç†ç›¸å…³æŒ‰é’®
                const addUserBtn = document.getElementById('add-user-btn');
                if (addUserBtn) {
                    addUserBtn.addEventListener('click', () => {
                        console.log('ğŸ” æ·»åŠ ç”¨æˆ·æŒ‰é’®è¢«ç‚¹å‡»');
                        this.showAddUserModal();
                    });
                }

                const refreshUsersBtn = document.getElementById('refresh-users-btn');
                if (refreshUsersBtn) {
                    refreshUsersBtn.addEventListener('click', () => {
                        console.log('ğŸ” åˆ·æ–°ç”¨æˆ·åˆ—è¡¨æŒ‰é’®è¢«ç‚¹å‡»');
                        this.loadUsers();
                    });
                }

                // å¯¼èˆªæŒ‰é’®
                const navButtons = document.querySelectorAll('.nav-btn');
                navButtons.forEach(button => {
                    button.addEventListener('click', function() {
                        const tabName = this.getAttribute('data-tab');
                        switchTab(tabName);
                    });
                });
            }

            async handleLogin() {
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                
                try {
                    const response = await fetch(`${this.apiBaseUrl}/login`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify({ username, password })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        this.currentUser = data.user;
                        this.isAuthenticated = true;
                        this.showMainInterface();
                        showNotification('ç™»å½•æˆåŠŸ', 'success');
                    } else {
                        showNotification(data.error || 'ç™»å½•å¤±è´¥', 'error');
                    }
                } catch (error) {
                    console.error('ç™»å½•å¤±è´¥:', error);
                    showNotification('ç½‘ç»œé”™è¯¯', 'error');
                }
            }

            showMainInterface() {
                document.getElementById('login-container').style.display = 'none';
                document.getElementById('main-container').style.display = 'block';
            }

            async loadUsers() {
                console.log('ğŸ” å¼€å§‹åŠ è½½ç”¨æˆ·åˆ—è¡¨');
                console.log('å½“å‰ç”¨æˆ·:', this.currentUser);
                
                if (!this.currentUser || this.currentUser.role !== 'admin') {
                    console.error('âŒ æƒé™ä¸è¶³ï¼Œæ— æ³•åŠ è½½ç”¨æˆ·åˆ—è¡¨');
                    showNotification('æƒé™ä¸è¶³', 'error');
                    this.displayUsers([]);
                    return;
                }

                try {
                    showLoading('æ­£åœ¨åŠ è½½ç”¨æˆ·åˆ—è¡¨...');
                    
                    const response = await fetch(`${this.apiBaseUrl}/users`, {
                        method: 'GET',
                        credentials: 'include'
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        console.log('âœ… ç”¨æˆ·åˆ—è¡¨åŠ è½½æˆåŠŸï¼Œç”¨æˆ·æ•°é‡:', data.users.length);
                        this.displayUsers(data.users);
                    } else {
                        console.error('âŒ åŠ è½½ç”¨æˆ·åˆ—è¡¨å¤±è´¥:', data.error);
                        showNotification(data.error || 'åŠ è½½ç”¨æˆ·åˆ—è¡¨å¤±è´¥', 'error');
                        this.displayUsers([]);
                    }
                } catch (error) {
                    console.error('âŒ åŠ è½½ç”¨æˆ·åˆ—è¡¨å¤±è´¥:', error);
                    showNotification('ç½‘ç»œé”™è¯¯', 'error');
                    this.displayUsers([]);
                } finally {
                    hideLoading();
                }
            }

            displayUsers(users) {
                console.log('ğŸ” å¼€å§‹æ˜¾ç¤ºç”¨æˆ·åˆ—è¡¨ï¼Œç”¨æˆ·æ•°é‡:', users.length);
                console.log('ğŸ” ç”¨æˆ·æ•°æ®:', users);
                
                const usersTable = document.getElementById('users-table');
                console.log('ğŸ” ç”¨æˆ·è¡¨æ ¼å…ƒç´ :', usersTable);
                
                if (!usersTable) {
                    console.error('âŒ æ‰¾ä¸åˆ°ç”¨æˆ·è¡¨æ ¼å…ƒç´ ');
                    return;
                }
                
                if (users.length === 0) {
                    console.log('ğŸ“ ç”¨æˆ·åˆ—è¡¨ä¸ºç©º');
                    usersTable.innerHTML = '<p>æš‚æ— ç”¨æˆ·</p>';
                    return;
                }
                
                let html = `
                    <table>
                        <thead>
                            <tr>
                                <th>ç”¨æˆ·å</th>
                                <th>è§’è‰²</th>
                                <th>åˆ›å»ºæ—¶é—´</th>
                                <th>æœ€åç™»å½•</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                users.forEach(user => {
                    const createdTime = user.created_at ? new Date(user.created_at * 1000).toLocaleString() : 'æœªçŸ¥';
                    const lastLogin = user.last_login ? new Date(user.last_login * 1000).toLocaleString() : 'ä»æœªç™»å½•';
                    
                    html += `
                        <tr>
                            <td>${user.username}</td>
                            <td>${user.role === 'admin' ? 'ç®¡ç†å‘˜' : 'ç”¨æˆ·'}</td>
                            <td>${createdTime}</td>
                            <td>${lastLogin}</td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
                usersTable.innerHTML = html;
                console.log('âœ… ç”¨æˆ·åˆ—è¡¨æ˜¾ç¤ºå®Œæˆ');
            }

            showAddUserModal() {
                showNotification('æ·»åŠ ç”¨æˆ·åŠŸèƒ½å¼€å‘ä¸­', 'info');
            }

            testUserManagement() {
                console.log('ğŸ§ª å¼€å§‹ç”¨æˆ·ç®¡ç†åŠŸèƒ½æµ‹è¯•');
                console.log('å½“å‰ç”¨æˆ·:', this.currentUser);
                console.log('è®¤è¯çŠ¶æ€:', this.isAuthenticated);
                
                const usersTable = document.getElementById('users-table');
                console.log('ç”¨æˆ·è¡¨æ ¼å…ƒç´ :', usersTable);
                
                if (usersTable) {
                    console.log('ç”¨æˆ·è¡¨æ ¼å†…å®¹:', usersTable.innerHTML);
                }
            }
        }

        // åˆ›å»ºå…¨å±€è®¤è¯ç®¡ç†å™¨å®ä¾‹
        const authManager = new AuthManager();

        // åˆ‡æ¢æ ‡ç­¾é¡µ
        function switchTab(tabName) {
            console.log('ğŸ” åˆ‡æ¢åˆ°æ ‡ç­¾é¡µ:', tabName);
            
            // éšè—æ‰€æœ‰æ ‡ç­¾é¡µå†…å®¹
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(content => {
                content.classList.remove('active');
            });
            
            // ç§»é™¤æ‰€æœ‰å¯¼èˆªæŒ‰é’®çš„æ¿€æ´»çŠ¶æ€
            const navButtons = document.querySelectorAll('.nav-btn');
            navButtons.forEach(button => {
                button.classList.remove('active');
            });
            
            // æ˜¾ç¤ºé€‰ä¸­çš„æ ‡ç­¾é¡µ
            const targetTab = document.getElementById(tabName);
            if (targetTab) {
                targetTab.classList.add('active');
            }
            
            // æ¿€æ´»å¯¹åº”çš„å¯¼èˆªæŒ‰é’®
            const targetButton = document.querySelector(`[data-tab="${tabName}"]`);
            if (targetButton) {
                targetButton.classList.add('active');
            }
            
            // ç‰¹æ®Šå¤„ç†ï¼šç”¨æˆ·ç®¡ç†é¡µé¢è‡ªåŠ¨åŠ è½½ç”¨æˆ·åˆ—è¡¨
            if (tabName === 'user-management') {
                console.log('ğŸ” åˆ‡æ¢åˆ°ç”¨æˆ·ç®¡ç†é¡µé¢');
                if (authManager && authManager.currentUser && authManager.currentUser.role === 'admin') {
                    console.log('ğŸ” ç”¨æˆ·æ˜¯ç®¡ç†å‘˜ï¼Œè‡ªåŠ¨åŠ è½½ç”¨æˆ·åˆ—è¡¨');
                    setTimeout(() => {
                        authManager.loadUsers();
                    }, 100);
                } else {
                    console.log('ğŸ” ç”¨æˆ·ä¸æ˜¯ç®¡ç†å‘˜ï¼Œæ˜¾ç¤ºæƒé™ä¸è¶³');
                    const usersTable = document.getElementById('users-table');
                    if (usersTable) {
                        usersTable.innerHTML = '<p>æƒé™ä¸è¶³ï¼Œåªæœ‰ç®¡ç†å‘˜å¯ä»¥æŸ¥çœ‹ç”¨æˆ·åˆ—è¡¨</p>';
                    }
                }
            }
        }

        // ç™»å½•å‡½æ•°
        async function login() {
            await authManager.handleLogin();
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸš€ åˆå§‹åŒ–æ¨¡æ‹ŸElectronåº”ç”¨...');
            authManager.initialize();
            
            // æµ‹è¯•ç”¨æˆ·ç®¡ç†åŠŸèƒ½
            setTimeout(() => {
                authManager.testUserManagement();
            }, 1000);
            
            console.log('âœ… æ¨¡æ‹ŸElectronåº”ç”¨åˆå§‹åŒ–å®Œæˆ');
        });
    </script>
</body>
</html> 