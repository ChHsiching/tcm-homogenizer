<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Electron环境模拟测试</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .section { margin: 20px 0; padding: 20px; border: 1px solid #ccc; }
        .btn { padding: 10px 20px; margin: 5px; cursor: pointer; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .nav-btn { padding: 10px 20px; margin: 5px; cursor: pointer; }
        .nav-btn.active { background-color: #007bff; color: white; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Electron环境模拟测试</h1>
        
        <!-- 登录界面 -->
        <div id="login-container" class="section">
            <h2>登录</h2>
            <input type="text" id="username" placeholder="用户名" value="admin">
            <input type="password" id="password" placeholder="密码" value="admin123">
            <button class="btn" onclick="login()">登录</button>
            <div id="login-status"></div>
        </div>
        
        <!-- 主界面 -->
        <div id="main-container" class="section" style="display: none;">
            <h2>主界面</h2>
            
            <!-- 导航菜单 -->
            <div class="nav-menu">
                <button class="nav-btn active" data-tab="home">首页</button>
                <button class="nav-btn" data-tab="user-management">用户管理</button>
            </div>
            
            <!-- 标签页内容 -->
            <div id="home" class="tab-content active">
                <h3>首页</h3>
                <p>欢迎使用系统</p>
            </div>
            
            <div id="user-management" class="tab-content">
                <h3>用户管理</h3>
                <div class="user-section">
                    <div class="user-actions">
                        <button id="add-user-btn" class="btn">添加用户</button>
                        <button id="refresh-users-btn" class="btn">刷新列表</button>
                    </div>
                    <div class="user-list">
                        <h4>用户列表</h4>
                        <div id="users-table" class="data-table">
                            <p>加载中...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 模拟Electron API
        window.electronAPI = {
            onMenuImportData: (callback) => console.log('菜单事件监听器已设置'),
            onMenuExportResults: (callback) => console.log('菜单事件监听器已设置'),
            onMenuSymbolicRegression: (callback) => console.log('菜单事件监听器已设置'),
            onMenuMonteCarlo: (callback) => console.log('菜单事件监听器已设置'),
            onMenuAbout: (callback) => console.log('菜单事件监听器已设置')
        };

        // 全局函数
        function showNotification(message, type = 'info') {
            console.log(`通知 [${type}]: ${message}`);
        }

        function showLoading(text = '正在处理...') {
            console.log(`加载: ${text}`);
        }

        function hideLoading() {
            console.log('隐藏加载状态');
        }

        // 认证管理器
        class AuthManager {
            constructor() {
                this.currentUser = null;
                this.isAuthenticated = false;
                this.apiBaseUrl = 'http://127.0.0.1:5000/api/auth';
            }

            async initialize() {
                console.log('🔐 初始化认证系统...');
                this.setupAuthEventListeners();
                console.log('✅ 认证系统初始化完成');
            }

            setupAuthEventListeners() {
                // 用户管理相关按钮
                const addUserBtn = document.getElementById('add-user-btn');
                if (addUserBtn) {
                    addUserBtn.addEventListener('click', () => {
                        console.log('🔍 添加用户按钮被点击');
                        this.showAddUserModal();
                    });
                }

                const refreshUsersBtn = document.getElementById('refresh-users-btn');
                if (refreshUsersBtn) {
                    refreshUsersBtn.addEventListener('click', () => {
                        console.log('🔍 刷新用户列表按钮被点击');
                        this.loadUsers();
                    });
                }

                // 导航按钮
                const navButtons = document.querySelectorAll('.nav-btn');
                navButtons.forEach(button => {
                    button.addEventListener('click', function() {
                        const tabName = this.getAttribute('data-tab');
                        switchTab(tabName);
                    });
                });
            }

            async handleLogin() {
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                
                try {
                    const response = await fetch(`${this.apiBaseUrl}/login`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify({ username, password })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        this.currentUser = data.user;
                        this.isAuthenticated = true;
                        this.showMainInterface();
                        showNotification('登录成功', 'success');
                    } else {
                        showNotification(data.error || '登录失败', 'error');
                    }
                } catch (error) {
                    console.error('登录失败:', error);
                    showNotification('网络错误', 'error');
                }
            }

            showMainInterface() {
                document.getElementById('login-container').style.display = 'none';
                document.getElementById('main-container').style.display = 'block';
            }

            async loadUsers() {
                console.log('🔍 开始加载用户列表');
                console.log('当前用户:', this.currentUser);
                
                if (!this.currentUser || this.currentUser.role !== 'admin') {
                    console.error('❌ 权限不足，无法加载用户列表');
                    showNotification('权限不足', 'error');
                    this.displayUsers([]);
                    return;
                }

                try {
                    showLoading('正在加载用户列表...');
                    
                    const response = await fetch(`${this.apiBaseUrl}/users`, {
                        method: 'GET',
                        credentials: 'include'
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        console.log('✅ 用户列表加载成功，用户数量:', data.users.length);
                        this.displayUsers(data.users);
                    } else {
                        console.error('❌ 加载用户列表失败:', data.error);
                        showNotification(data.error || '加载用户列表失败', 'error');
                        this.displayUsers([]);
                    }
                } catch (error) {
                    console.error('❌ 加载用户列表失败:', error);
                    showNotification('网络错误', 'error');
                    this.displayUsers([]);
                } finally {
                    hideLoading();
                }
            }

            displayUsers(users) {
                console.log('🔍 开始显示用户列表，用户数量:', users.length);
                console.log('🔍 用户数据:', users);
                
                const usersTable = document.getElementById('users-table');
                console.log('🔍 用户表格元素:', usersTable);
                
                if (!usersTable) {
                    console.error('❌ 找不到用户表格元素');
                    return;
                }
                
                if (users.length === 0) {
                    console.log('📝 用户列表为空');
                    usersTable.innerHTML = '<p>暂无用户</p>';
                    return;
                }
                
                let html = `
                    <table>
                        <thead>
                            <tr>
                                <th>用户名</th>
                                <th>角色</th>
                                <th>创建时间</th>
                                <th>最后登录</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                users.forEach(user => {
                    const createdTime = user.created_at ? new Date(user.created_at * 1000).toLocaleString() : '未知';
                    const lastLogin = user.last_login ? new Date(user.last_login * 1000).toLocaleString() : '从未登录';
                    
                    html += `
                        <tr>
                            <td>${user.username}</td>
                            <td>${user.role === 'admin' ? '管理员' : '用户'}</td>
                            <td>${createdTime}</td>
                            <td>${lastLogin}</td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
                usersTable.innerHTML = html;
                console.log('✅ 用户列表显示完成');
            }

            showAddUserModal() {
                showNotification('添加用户功能开发中', 'info');
            }

            testUserManagement() {
                console.log('🧪 开始用户管理功能测试');
                console.log('当前用户:', this.currentUser);
                console.log('认证状态:', this.isAuthenticated);
                
                const usersTable = document.getElementById('users-table');
                console.log('用户表格元素:', usersTable);
                
                if (usersTable) {
                    console.log('用户表格内容:', usersTable.innerHTML);
                }
            }
        }

        // 创建全局认证管理器实例
        const authManager = new AuthManager();

        // 切换标签页
        function switchTab(tabName) {
            console.log('🔍 切换到标签页:', tabName);
            
            // 隐藏所有标签页内容
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(content => {
                content.classList.remove('active');
            });
            
            // 移除所有导航按钮的激活状态
            const navButtons = document.querySelectorAll('.nav-btn');
            navButtons.forEach(button => {
                button.classList.remove('active');
            });
            
            // 显示选中的标签页
            const targetTab = document.getElementById(tabName);
            if (targetTab) {
                targetTab.classList.add('active');
            }
            
            // 激活对应的导航按钮
            const targetButton = document.querySelector(`[data-tab="${tabName}"]`);
            if (targetButton) {
                targetButton.classList.add('active');
            }
            
            // 特殊处理：用户管理页面自动加载用户列表
            if (tabName === 'user-management') {
                console.log('🔍 切换到用户管理页面');
                if (authManager && authManager.currentUser && authManager.currentUser.role === 'admin') {
                    console.log('🔍 用户是管理员，自动加载用户列表');
                    setTimeout(() => {
                        authManager.loadUsers();
                    }, 100);
                } else {
                    console.log('🔍 用户不是管理员，显示权限不足');
                    const usersTable = document.getElementById('users-table');
                    if (usersTable) {
                        usersTable.innerHTML = '<p>权限不足，只有管理员可以查看用户列表</p>';
                    }
                }
            }
        }

        // 登录函数
        async function login() {
            await authManager.handleLogin();
        }

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 初始化模拟Electron应用...');
            authManager.initialize();
            
            // 测试用户管理功能
            setTimeout(() => {
                authManager.testUserManagement();
            }, 1000);
            
            console.log('✅ 模拟Electron应用初始化完成');
        });
    </script>
</body>
</html> 