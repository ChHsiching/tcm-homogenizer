<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>本草智配</title>
    <link rel="stylesheet" href="styles/main.css">
</head>
<body>
    <!-- 登录界面 -->
    <div id="login-container" class="login-container">
        <div class="login-box">
            <div class="login-logo">
                <img src="assets/icons/logo.png" alt="本草智配" class="logo-image">
            </div>
            <h2>本草智配</h2>
            <div id="first-run-message" class="first-run-message" style="display: none;">
                <p>首次启动，请创建管理员账号</p>
            </div>
            <form id="login-form">
                <div class="form-group">
                    <label for="username">用户名</label>
                    <input type="text" id="username" name="username" required>
                </div>
                <div class="form-group">
                    <label for="password">密码</label>
                    <input type="password" id="password" name="password" required>
                </div>
                <div class="form-group">
                    <button type="submit" id="login-btn">登录</button>
                </div>
            </form>
            <div id="login-error" class="error-message" style="display: none;"></div>
        </div>
    </div>

    <!-- 主应用界面 -->
    <div id="main-container" class="main-container" style="display: none;">
        <!-- 顶部导航栏 -->
        <header class="header">
            <div class="header-left">
                <div class="header-logo">
                    <img src="assets/icons/logo.png" alt="本草智配" class="header-logo-image">
                </div>
                <h1>本草智配</h1>
            </div>
            <div class="header-right">
                <span id="user-info" class="user-info"></span>
                <button id="logout-btn" class="btn-secondary">退出登录</button>
            </div>
        </header>

        <!-- 导航菜单 -->
        <nav class="nav-menu">
            <button class="nav-btn active" data-tab="home">首页</button>
            <button class="nav-btn" data-tab="regression">符号回归</button>
            <button class="nav-btn" data-tab="monte-carlo">蒙特卡洛采样</button>
            <button class="nav-btn admin-only" data-tab="data-management">数据管理</button>
            <button class="nav-btn admin-only" data-tab="user-management">用户管理</button>
            <button class="nav-btn" data-tab="settings">设置</button>
        </nav>

        <!-- 主要内容区域 -->
        <main class="main-content">
            <!-- 首页 -->
            <div id="home" class="tab-content active">
                <h2>欢迎使用本草智配</h2>
                <div class="welcome-content">
                    <p>本系统提供中药多组分配比分析功能，包括：</p>
                    <ul>
                        <li><strong>符号回归分析</strong>：通过遗传算法发现数据中的数学关系</li>
                        <li><strong>蒙特卡洛采样</strong>：模拟不同配比组合的药效表现</li>
                        <li><strong>数据管理</strong>：上传、管理和导出分析数据</li>
                        <li><strong>用户管理</strong>：管理系统用户和权限</li>
                    </ul>
                    <div class="status-info">
                        <p><strong>后端状态</strong>：<span id="connection-status">检查中...</span></p>
                        <p><strong>当前用户</strong>：<span id="current-user">未登录</span></p>
                        <p><strong>用户角色</strong>：<span id="user-role">未知</span></p>
                    </div>
                </div>
            </div>

            <!-- 符号回归分析 -->
            <div id="regression" class="tab-content">
                <h2>符号回归分析</h2>
                <div class="analysis-section">
                    <div class="input-section">
                        <h3>数据输入</h3>
                        <div class="form-group">
                            <label for="regression-data">选择数据文件</label>
                            <input type="file" id="regression-data" accept=".csv,.xlsx,.xls">
                        </div>
                        <div class="form-group">
                            <label for="target-column">目标变量</label>
                            <select id="target-column">
                                <option value="">请先上传数据</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>特征变量</label>
                            <div id="feature-columns" class="checkbox-group">
                                <!-- 动态生成复选框 -->
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="population-size">配比方案数量</label>
                            <input type="number" id="population-size" value="100" min="10" max="1000">
                        </div>
                        <div class="form-group">
                            <label for="generations">优化轮次</label>
                            <input type="number" id="generations" value="50" min="10" max="500">
                        </div>
                        <button id="start-regression" class="btn-primary">开始分析</button>
                    </div>
                    <div class="result-section">
                        <h3>分析结果</h3>
                        <div id="regression-results" class="results-container">
                            <p>请先上传数据并开始分析</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 蒙特卡洛采样 -->
            <div id="monte-carlo" class="tab-content">
                <h2>蒙特卡洛采样</h2>
                <div class="analysis-section">
                    <div class="input-section">
                        <h3>分析参数</h3>
                        <div class="form-group">
                            <label for="mc-model">选择回归模型</label>
                            <select id="mc-model">
                                <option value="">请先完成符号回归分析</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="mc-iterations">采样次数</label>
                            <input type="number" id="mc-iterations" value="1000" min="100" max="10000">
                        </div>
                        <div class="form-group">
                            <label for="target-efficacy">目标药效值</label>
                            <input type="number" id="target-efficacy" step="0.1" min="0">
                        </div>
                        <div class="form-group">
                            <label for="tolerance">容差</label>
                            <input type="number" id="tolerance" value="0.1" step="0.01" min="0.01">
                        </div>
                        <button id="start-monte-carlo" class="btn-primary">开始分析</button>
                    </div>
                    <div class="result-section">
                        <h3>分析结果</h3>
                        <div id="monte-carlo-results" class="results-container">
                            <p>请先选择回归模型并设置参数</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 数据管理（管理员功能） -->
            <div id="data-management" class="tab-content">
                <h2>数据管理</h2>
                <div class="data-section">
                    <div class="data-actions">
                        <h3>数据操作</h3>
                        <button id="import-data-btn" class="btn-primary">导入数据</button>
                        <button id="export-data-btn" class="btn-secondary">导出数据</button>
                        <button id="clear-data-btn" class="btn-danger">清空数据</button>
                    </div>
                    <div class="data-preview">
                        <h3>数据预览</h3>
                        <div id="data-preview" class="data-table">
                            <p>暂无数据</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 用户管理（管理员功能） -->
            <div id="user-management" class="tab-content">
                <h2>用户管理</h2>
                <div class="user-section">
                    <div class="user-actions">
                        <h3>用户操作</h3>
                        <button id="add-user-btn" class="btn-primary">添加用户</button>
                        <button id="refresh-users-btn" class="btn-secondary">刷新列表</button>
                    </div>
                    <div class="user-list">
                        <h3>用户列表</h3>
                        <div id="users-table" class="data-table">
                            <p>加载中...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 设置 -->
            <div id="settings" class="tab-content">
                <h2>系统设置</h2>
                <div class="settings-section">
                    <div class="form-group">
                        <label for="backend-port">后端端口</label>
                        <input type="number" id="backend-port" value="5000" min="1000" max="9999">
                    </div>
                    <div class="form-group">
                        <label for="auto-start-backend">
                            <input type="checkbox" id="auto-start-backend" checked>
                            自动启动后端服务
                        </label>
                    </div>
                    <div class="form-group">
                        <label for="theme">主题</label>
                        <select id="theme">
                            <option value="dark">深色</option>
                            <option value="light">浅色</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="language">语言</label>
                        <select id="language">
                            <option value="zh-CN">中文</option>
                            <option value="en-US">English</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="default-format">默认格式</label>
                        <select id="default-format">
                            <option value="csv">CSV</option>
                            <option value="xlsx">Excel</option>
                            <option value="json">JSON</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="auto-save">
                            <input type="checkbox" id="auto-save">
                            自动保存
                        </label>
                    </div>
                    <button id="save-settings" class="btn-primary">保存设置</button>
                </div>
            </div>
        </main>

        <!-- 状态栏 -->
        <footer class="status-bar">
            <div class="status-left">
                <span id="connection-status-footer">后端服务：检查中...</span>
            </div>
            <div class="status-right">
                <span id="current-time">2025-08-03 19:00:00</span>
            </div>
        </footer>
    </div>

    <!-- 加载遮罩 -->
    <div id="loading-overlay" class="loading-overlay" style="display: none;">
        <div class="loading-content">
            <div class="spinner"></div>
            <p id="loading-text">正在处理...</p>
        </div>
    </div>

    <!-- 通知容器 -->
    <div id="notification-container" class="notification-container"></div>

    <!-- 模态框 -->
    <div id="modal-overlay" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title">标题</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body" id="modal-body">
                <!-- 模态框内容 -->
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" id="modal-cancel">取消</button>
                <button class="btn-primary" id="modal-confirm">确认</button>
            </div>
        </div>
    </div>

    <script src="scripts/auth.js"></script>
    <script src="scripts/renderer.js"></script>
    <script>
        // 调试脚本
        console.log('主页面脚本加载完成');
        
        // 直接测试用户列表加载
        setTimeout(() => {
            console.log('开始直接测试用户列表加载');
            
            // 直接调用API获取用户列表
            fetch('http://127.0.0.1:5000/api/auth/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({ username: 'admin', password: 'admin123' })
            })
            .then(response => {
                console.log('登录响应状态:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('登录结果:', data);
                if (data.success) {
                    // 登录成功后获取用户列表
                    return fetch('http://127.0.0.1:5000/api/auth/users', {
                        method: 'GET',
                        credentials: 'include'
                    });
                } else {
                    throw new Error('登录失败: ' + data.error);
                }
            })
            .then(response => {
                console.log('用户列表响应状态:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('用户列表结果:', data);
                if (data.success) {
                    // 更新页面显示
                    const usersTable = document.getElementById('users-table');
                    if (usersTable) {
                        let html = '<table><thead><tr><th>用户名</th><th>角色</th><th>创建时间</th><th>最后登录</th></tr></thead><tbody>';
                        data.users.forEach(user => {
                            const createdTime = user.created_at ? new Date(user.created_at * 1000).toLocaleString() : '未知';
                            const lastLogin = user.last_login ? new Date(user.last_login * 1000).toLocaleString() : '从未登录';
                            html += `<tr><td>${user.username}</td><td>${user.role === 'admin' ? '管理员' : '用户'}</td><td>${createdTime}</td><td>${lastLogin}</td></tr>`;
                        });
                        html += '</tbody></table>';
                        usersTable.innerHTML = html;
                        console.log('用户列表更新完成');
                    }
                } else {
                    throw new Error('获取用户列表失败: ' + data.error);
                }
            })
            .catch(error => {
                console.error('API调用失败:', error);
                // 显示错误信息
                const usersTable = document.getElementById('users-table');
                if (usersTable) {
                    usersTable.innerHTML = '<p>加载失败: ' + error.message + '</p>';
                }
            });
        }, 3000);
    </script>
</body>
</html> 